<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Rodent Royal</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#0984e3',
              accent: '#00b894',
              danger: '#ff4757',
            },
            animation: {
              'shake': 'shake 0.4s cubic-bezier(.36,.07,.19,.97) both',
              'pop': 'pop 0.6s forwards',
              'fade-in': 'fade-in 0.3s ease-out forwards', // Added fade-in
            },
            keyframes: {
              shake: {
                '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
              },
              pop: {
                '0%': { transform: 'scale(0)', opacity: '0' },
                '50%': { transform: 'scale(1.5) translateY(-20px)', opacity: '1' },
                '100%': { transform: 'translateY(-60px)', opacity: '0' }
              },
              // Define fade-in for modals
              'fade-in': {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' }
              }
            }
          }
        }
      }
    </script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        user-select: none;
        -webkit-user-select: none;
        background: linear-gradient(135deg, #74b9ff, #0984e3, #00b894);
        font-family: system-ui, -apple-system, sans-serif;
      }
      
      @keyframes fall {
        from { top: -100px; transform: rotate(0deg) scale(0.7); }
        50% { transform: rotate(360deg) scale(1); }
        to { top: 110vh; transform: rotate(720deg) scale(1.05); }
      }

      .paused {
        animation-play-state: paused !important;
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 4px; }
      ::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
      ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
    </style>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1",
    "@tonconnect/ui-react": "https://esm.sh/@tonconnect/ui-react@2.0.0-beta.6?external=react,react-dom",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
    "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
    "firebase/database": "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js",
    "firebase/functions": "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js",
    "firebase/analytics": "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "firebase/": "https://aistudiocdn.com/firebase@^12.6.0/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Play, Hammer, RotateCcw, ShoppingBag, Rocket, Trophy, X, ExternalLink, Users, Clipboard } from 'lucide-react';
        import { TonConnectUIProvider, TonConnectButton } from '@tonconnect/ui-react';
        
        // Firebase Imports
        import { initializeApp } from "firebase/app";
        import { getDatabase, ref, push, onValue, query, orderByChild, limitToLast } from "firebase/database";
        import { getAuth, signInAnonymously } from "firebase/auth";
        import { getFunctions, httpsCallable } from "firebase/functions";
        import { getAnalytics } from "firebase/analytics";

        // --- TYPES ---
        const GameState = {
          MENU: 'MENU',
          PLAYING: 'PLAYING',
          GAME_OVER: 'GAME_OVER',
          ALL_DONE: 'ALL_DONE',
          SHOP: 'SHOP',
          REFERRAL: 'REFERRAL' // Added REFERRAL state
        };

        const ItemType = {
          MELON: 'MELON',
          BOMB: 'BOMB',
          ICE: 'ICE'
        };

        // --- FIREBASE SERVICE ---
        // REPLACE WITH YOUR ACTUAL CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyB9VtW1YpDfM9UynxFQvv9-OSRtf-U7Z_k",
          authDomain: "redent-royal.firebaseapp.com",
          databaseURL: "https://redent-royal-default-rtdb.firebaseio.com",
          projectId: "redent-royal",
          storageBucket: "redent-royal.firebasestorage.app",
          messagingSenderId: "683092186570",
          appId: "1:683092186570:web:aa3985c9c7f07bc38eeb33",
          measurementId: "G-B9LLS9R4ZW"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const functions = getFunctions(app);

        // Authenticate immediately
        signInAnonymously(auth).catch((err) => {
          console.error("Anonymous auth failed:", err);
        });

        const submitScore = async (name, score) => {
          try {
            if (!auth.currentUser) await signInAnonymously(auth);
            const scoresRef = ref(db, 'scores');
            await push(scoresRef, { name, score, timestamp: Date.now() });
          } catch (e) {
            console.error("Error submitting score", e);
          }
        };

        const subscribeToLeaderboard = (callback) => {
          const scoresQuery = query(ref(db, 'scores'), orderByChild('score'), limitToLast(10));
          const unsubscribe = onValue(scoresQuery, (snapshot) => {
            const data = snapshot.val();
            if (data) {
              const parsedScores = Object.entries(data).map(([key, value]) => ({
                id: key,
                name: value.name,
                score: value.score,
                timestamp: value.timestamp
              }));
              callback(parsedScores.sort((a, b) => b.score - a.score));
            } else {
              callback([]);
            }
          }, (error) => console.error("Leaderboard subscription error:", error));
          return () => unsubscribe();
        };

        // --- AUDIO SERVICE ---
        let audioCtx = null;
        const getAudioContext = () => {
          if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          return audioCtx;
        };

        const initAudio = () => {
          const ctx = getAudioContext();
          if (ctx.state === 'suspended') ctx.resume().catch(e => console.error(e));
        };

        const playMelonSound = () => {
            try {
                const ctx = getAudioContext();
                const osc = ctx.createOscillator();
                const gainNode = ctx.createGain();
                osc.connect(gainNode);
                gainNode.connect(ctx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1600, ctx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
                osc.start();
                osc.stop(ctx.currentTime + 0.15);
            } catch (e) {}
        };

        const playBombSound = () => {
            try {
                const ctx = getAudioContext();
                const osc = ctx.createOscillator();
                const gainNode = ctx.createGain();
                osc.connect(gainNode);
                gainNode.connect(ctx.destination);
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                osc.start();
                osc.stop(ctx.currentTime + 0.5);
            } catch (e) {}
        };

        const playIceSound = () => {
            try {
                const ctx = getAudioContext();
                const osc = ctx.createOscillator();
                const gainNode = ctx.createGain();
                osc.connect(gainNode);
                gainNode.connect(ctx.destination);
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(1200, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(1000, ctx.currentTime + 0.4);
                gainNode.gain.setValueAtTime(0.15, ctx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.4);
                osc.start();
                osc.stop(ctx.currentTime + 0.4);
            } catch (e) {}
        };

        // --- STORAGE SERVICE ---
        const STORAGE_KEY_TOTAL = 'rodent_royal_total';
        const STORAGE_KEY_PLAYS = 'rodent_royal_plays';
        const STORAGE_KEY_DATE = 'rodent_royal_date';
        const STORAGE_KEY_MINED = 'rodent_royal_mined';
        
        // ADDED: Track if referral has been processed for this session/user
        const STORAGE_KEY_REF_PROCESSED = 'rodent_royal_ref_processed';

        const getProgress = () => {
          const today = new Date().toDateString();
          const storedDate = localStorage.getItem(STORAGE_KEY_DATE);
          let plays = 3;
          let minedDate = localStorage.getItem(STORAGE_KEY_MINED) || '';
          
          if (storedDate !== today) {
            localStorage.setItem(STORAGE_KEY_DATE, today);
            localStorage.setItem(STORAGE_KEY_PLAYS, '3');
          } else {
            plays = parseInt(localStorage.getItem(STORAGE_KEY_PLAYS) || '3', 10);
          }
          const totalScore = parseInt(localStorage.getItem(STORAGE_KEY_TOTAL) || '0', 10);
          
          return { totalScore, playsLeft: plays, lastPlayedDate: today, lastMinedDate: minedDate };
        };

        const saveProgress = (scoreToAdd, playsDecrement) => {
          const currentTotal = parseInt(localStorage.getItem(STORAGE_KEY_TOTAL) || '0', 10);
          const currentPlays = parseInt(localStorage.getItem(STORAGE_KEY_PLAYS) || '3', 10);
          localStorage.setItem(STORAGE_KEY_TOTAL, (currentTotal + scoreToAdd).toString());
          localStorage.setItem(STORAGE_KEY_PLAYS, (currentPlays - playsDecrement).toString());
        };

        const markMinedToday = (amount) => {
           const today = new Date().toDateString();
           const currentTotal = parseInt(localStorage.getItem(STORAGE_KEY_TOTAL) || '0', 10);
           localStorage.setItem(STORAGE_KEY_TOTAL, (currentTotal + amount).toString());
           localStorage.setItem(STORAGE_KEY_MINED, today);
        };
        
        // UPDATED: Function to generate the Telegram deep link with the correct bot username
        const getReferralLink = (userId) => {
            const botUsername = "rodentroyaleBot"; 
            if (!userId) return `https://t.me/${botUsername}`;
            return `https://t.me/${botUsername}?start=${userId}`;
        };

        // --- COMPONENTS ---
        
        // Button Component
        const Button = ({ children, variant = 'primary', fullWidth = false, className = '', ...props }) => {
          const baseStyles = "px-6 py-3 rounded-2xl font-bold shadow-lg transform transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed";
          const variants = {
            primary: "bg-white text-gray-800 hover:bg-gray-50 border-2 border-white/50",
            secondary: "bg-white/20 text-white backdrop-blur-md hover:bg-white/30 border border-white/30",
            danger: "bg-danger text-white hover:bg-red-600",
            connect: "bg-[#0088cc] text-white hover:bg-[#0077b5]",
            accent: "bg-accent text-white hover:bg-[#00a382] border-2 border-accent/50"
          };
          const widthClass = fullWidth ? "w-full" : "";
          return (
            <button className={`${baseStyles} ${variants[variant]} ${widthClass} ${className}`} {...props}>
              {children}
            </button>
          );
        };

        // FallingObject Component (Same as before)
        const FallingObject = ({ data, isFrozen, onHit, onMiss }) => {
          const [hasHit, setHasHit] = useState(false);
          const handleAnimationEnd = () => { if (!hasHit) onMiss(data.id); };
          const handlePointerDown = (e) => {
            e.preventDefault(); e.stopPropagation();
            if (hasHit) return;
            setHasHit(true);
            onHit(data.id, data.type, e.clientX, e.clientY);
          };
          const renderContent = () => {
            switch(data.type) {
              case ItemType.MELON: return 'üçà';
              case ItemType.BOMB: return 'üí£';
              case ItemType.ICE: return '‚ùÑÔ∏è';
              default: return '‚ùì';
            }
          };
          return (
            <div
              onPointerDown={handlePointerDown}
              onAnimationEnd={handleAnimationEnd}
              className={`absolute text-6xl cursor-pointer select-none z-10 will-change-transform ${isFrozen ? 'paused' : ''}`}
              style={{
                left: `${data.x}%`,
                top: '-100px',
                animation: `fall ${data.duration}s linear forwards`,
                animationPlayState: isFrozen ? 'paused' : 'running'
              }}
            >
              <div className="filter drop-shadow-lg transform transition-transform active:scale-95">
                {renderContent()}
              </div>
            </div>
          );
        };

        // Leaderboard Component (Same as before)
        const Leaderboard = ({ scores, loading }) => {
          return (
            <div className="w-full max-w-md bg-white/10 backdrop-blur-md rounded-2xl p-4 mt-4 border border-white/20">
              <div className="flex items-center justify-center gap-2 mb-4">
                <Trophy className="text-yellow-300" size={24} />
                <h2 className="text-xl font-bold text-white">Top Score</h2>
              </div>
              {loading ? (
                <div className="text-center py-4 text-white/70">Loading scores...</div>
              ) : (
                <ul className="space-y-2 max-h-48 overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-white/30">
                  {scores.map((entry, index) => (
                    <li key={entry.id || index} className="flex items-center justify-between bg-black/20 p-2 rounded-lg">
                      <div className="flex items-center gap-2">
                        <span className={`font-bold w-6 text-center ${index < 3 ? 'text-yellow-300' : 'text-white/60'}`}>
                          {index + 1}
                        </span>
                        <span className="text-white truncate max-w-[120px]">{entry.name}</span>
                      </div>
                      <div className="font-mono text-accent font-bold">
                        {entry.score} üçà
                      </div>
                    </li>
                  ))}
                  {scores.length === 0 && <li className="text-center text-white/50 py-2">No scores yet!</li>}
                </ul>
              )}
            </div>
          );
        };
        
        // Referral Modal Component (NEW)
        const ReferralModal = ({ onClose }) => {
            const [copied, setCopied] = useState(false);
            const user = window.Telegram?.WebApp?.initDataUnsafe?.user;
            const userId = user?.id;
            
            const inviteLink = getReferralLink(userId);

            const handleCopy = () => {
                if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(inviteLink)
                        .then(() => {
                            setCopied(true);
                            setTimeout(() => setCopied(false), 2000);
                            if (window.Telegram?.WebApp?.showPopup) {
                                window.Telegram.WebApp.showPopup({ message: "Referral link copied!", buttons: [{ text: "OK" }] });
                            }
                        })
                        .catch(err => console.error('Could not copy text: ', err));
                }
            };
            
            const handleShare = () => {
                 if (window.Telegram?.WebApp?.openTelegramLink) {
                    // Pre-filled message for sharing
                    const message = encodeURIComponent(`Join Rodent Royal and start earning Melons! üêπ Click my referral link to get a bonus: ${inviteLink}`);
                    // Opens Telegram chat with saved messages/another user. This is a common way to trigger sharing in TMA.
                    window.Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(inviteLink)}&text=${message}`);
                } else {
                    handleCopy(); // Fallback to copy
                }
            }

            return (
                <div className="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/80 backdrop-blur-md p-4 animate-fade-in">
                    <div className="w-full max-w-sm bg-gradient-to-br from-[#00b894] to-[#74b9ff] rounded-3xl p-6 shadow-2xl border border-white/20 relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-white/70 hover:text-white transition-colors">
                            <X size={24} />
                        </button>
                        <div className="flex items-center gap-3 mb-6">
                            <div className="bg-white/20 p-2 rounded-xl text-white"><Users size={24} /></div>
                            <h2 className="text-2xl font-black text-white">Invite Friends!</h2>
                        </div>
                        <p className="text-white/80 text-sm mb-6 leading-relaxed">
                            Invite a friend to get **2,000 Melons** and an extra **10% Daily Mine** bonus from them forever!
                        </p>
                        
                        <div className="bg-white/10 p-3 rounded-xl border border-white/30 mb-6 flex items-center justify-between gap-2">
                            <div className="text-white/70 text-sm truncate">{inviteLink}</div>
                            <Button variant="secondary" onClick={handleCopy} className="!px-3 !py-1 !text-xs !font-bold">
                                {copied ? '‚úÖ Copied' : <Clipboard size={16} />}
                            </Button>
                        </div>
                        
                        <Button onClick={handleShare} variant="primary" fullWidth className="text-lg py-3 bg-[#0984e3] text-white hover:bg-[#0077b5]">
                            Share Invite Link
                        </Button>
                        
                        <div className="mt-4 text-center text-white/50 text-xs">
                             Your ID: {userId || 'Loading...'}
                        </div>
                    </div>
                </div>
            );
        };


        // Shop Component (Same as before)
        const Shop = ({ onClose, onPurchase }) => {
          const [isLoading, setIsLoading] = useState(false);
          const packs = [
            { id: 'small', melons: 5000, priceUSDT: 5, name: 'Handful of Malons', desc: 'Small Boost', emoji: 'üçà' },
            { id: 'large', melons: 12000, priceUSDT: 10, name: 'Crate of Malons', desc: 'Mega Boost', emoji: 'üì¶' }
          ];

          const handleBuyClick = async (pack) => {
            setIsLoading(true);
            try {
              const telegramUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
              if (!telegramUser?.id) {
                console.error("Telegram User ID not found");
                alert("Please open this app in Telegram to make purchases.");
                setIsLoading(false);
                return;
              }
              const createInvoice = httpsCallable(functions, 'createInvoice');
              const result = await createInvoice({ telegramUserId: telegramUser.id, amount: pack.priceUSDT });
              const data = result.data;
              if (data && data.invoice_url) {
                if (window.Telegram?.WebApp?.openLink) window.Telegram.WebApp.openLink(data.invoice_url);
                else window.open(data.invoice_url, '_blank');
                onClose();
              } else {
                throw new Error("Invalid response from server: No invoice_url");
              }
            } catch (error) {
              console.error("Purchase failed:", error);
              alert("Failed to create invoice. Please try again.");
            } finally {
              setIsLoading(false);
            }
          };

          return (
            <div className="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/80 backdrop-blur-md p-4 animate-fade-in">
              <div className="w-full max-w-sm bg-gradient-to-br from-[#0984e3] to-[#74b9ff] rounded-3xl p-6 shadow-2xl border border-white/20 relative">
                <button onClick={onClose} className="absolute top-4 right-4 text-white/70 hover:text-white transition-colors">
                  <X size={24} />
                </button>
                <div className="flex items-center gap-3 mb-6">
                  <div className="bg-white/20 p-2 rounded-xl text-white"><ShoppingBag size={24} /></div>
                  <h2 className="text-2xl font-black text-white">Malon Shop</h2>
                </div>
                <p className="text-white/80 text-sm mb-6 leading-relaxed">Boost your rank! Buy <b>Malon Fruit</b> via USDT (TRC20).</p>
                <div className="space-y-4">
                  {packs.map(pack => (
                    <div key={pack.id} className="bg-white/10 hover:bg-white/20 transition-all border border-white/20 rounded-2xl p-4 flex items-center justify-between group">
                      <div className="flex items-center gap-4">
                        <div className="text-4xl group-hover:scale-110 transition-transform duration-300">{pack.emoji}</div>
                        <div>
                          <div className="font-bold text-white text-lg leading-tight">+{pack.melons.toLocaleString()} üçà</div>
                          <div className="text-white/60 text-xs font-mono mt-1">{pack.desc}</div>
                        </div>
                      </div>
                      <Button disabled={isLoading} onClick={() => handleBuyClick(pack)} className="text-sm px-4 py-2 !rounded-xl min-w-[100px]">
                        {isLoading ? '...' : <div className="flex flex-col items-center leading-none"><span>${pack.priceUSDT} USDT</span></div>}
                      </Button>
                    </div>
                  ))}
                </div>
                <div className="mt-6 text-center text-white/40 text-[10px] flex items-center justify-center gap-1">
                    Powered by NOWPayments <ExternalLink size={10} />
                </div>
              </div>
            </div>
          );
        };

        // --- MAIN APP COMPONENT ---
        const MANIFEST_URL = 'https://raw.githubusercontent.com/alifahmedkhanxyz/melon-clicker/main/tonconnect-manifest.json';

        const App = () => {
          const [gameState, setGameState] = useState(GameState.MENU);
          const [score, setScore] = useState(0);
          const [timeLeft, setTimeLeft] = useState(30);
          const [items, setItems] = useState([]);
          const [isFrozen, setIsFrozen] = useState(false);
          const [popEffects, setPopEffects] = useState([]);
          const [leaderboard, setLeaderboard] = useState([]);
          const [loadingLB, setLoadingLB] = useState(true);
          const [progress, setProgress] = useState({ totalScore: 0, playsLeft: 3, lastPlayedDate: '', lastMinedDate: '' });

          const timerRef = useRef(null);
          const spawnRef = useRef(null);
          const freezeRef = useRef(null);
          const scoreRef = useRef(0);
          const timeLeftRef = useRef(30);
          const frozenRef = useRef(false);

          useEffect(() => {
            const p = getProgress();
            setProgress(p);
            const unsubscribe = subscribeToLeaderboard((data) => {
              setLeaderboard(data);
              setLoadingLB(false);
            });

            if (window.Telegram?.WebApp) {
              window.Telegram.WebApp.ready();
              window.Telegram.WebApp.expand();
              const user = window.Telegram.WebApp.initDataUnsafe?.user;
              const userId = user?.id;
              
              if (userId) {
                // --- 1. REFERRAL LOGIC START ---
                const isProcessed = localStorage.getItem(STORAGE_KEY_REF_PROCESSED);
                const initData = window.Telegram?.WebApp?.initData || '';
                // Note: initData is URL-encoded, so we need to parse it.
                // The actual deep link parameter is extracted from Telegram WebApp properties (start_param) or from initData directly.
                const params = new URLSearchParams(initData);
                const startParam = params.get('start_param') || ''; // Inviter ID

                if (startParam && startParam !== userId.toString() && isProcessed !== 'true') {
                    // Call the Cloud Function to award bonuses and update Firebase
                    const handleReferral = httpsCallable(functions, 'handleReferral');
                    handleReferral({ 
                        inviterId: startParam, 
                        newUserId: userId.toString(), 
                        username: user.username || user.first_name || `Rodent-${userId}`
                    }).then(result => {
                        if (result.data.status === 'success') {
                             localStorage.setItem(STORAGE_KEY_REF_PROCESSED, 'true'); // Mark as processed
                             const msg = "Referral Bonus Received! Start playing.";
                             if (window.Telegram?.WebApp?.showAlert) window.Telegram.WebApp.showAlert(msg);
                             else alert(msg);
                             // Server will update the score, which is caught by the scoreUnsub below
                        } else if (result.data.message === 'User already attributed.') {
                             localStorage.setItem(STORAGE_KEY_REF_PROCESSED, 'true'); // Already processed, mark local
                        }
                    }).catch(e => console.error("Referral Error:", e));
                }
                // --- 1. REFERRAL LOGIC END ---
              
                // --- 2. Real-time Score Listener (for purchases and referrals) ---
                const userTotalScoreRef = ref(db, `users/${userId}/totalScore`);
                const scoreUnsub = onValue(userTotalScoreRef, (snapshot) => {
                    const serverScore = snapshot.val();
                    if (serverScore !== null) {
                      const localScore = parseInt(localStorage.getItem(STORAGE_KEY_TOTAL) || '0', 10);
                      if (serverScore !== localScore) {
                        const scoreDiff = serverScore - localScore;
                        saveProgress(scoreDiff, 0); // Update local score with the difference
                        setProgress(prev => ({ ...prev, totalScore: serverScore }));
                        if (scoreDiff > 0) {
                            playMelonSound();
                            const msg = `Score Updated! Total: ${serverScore.toLocaleString()} Melons.`;
                            if (window.Telegram?.WebApp?.showAlert) window.Telegram.WebApp.showAlert(msg);
                            else alert(msg);
                        }
                      }
                    }
                });
                return () => { unsubscribe(); clearIntervals(); scoreUnsub(); };
              }
            }
            return () => { unsubscribe(); clearIntervals(); };
          }, []);

          const clearIntervals = () => {
            if (timerRef.current) clearInterval(timerRef.current);
            if (spawnRef.current) clearInterval(spawnRef.current);
            if (freezeRef.current) clearTimeout(freezeRef.current);
          };

          const haptic = (style) => {
            if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred(style);
          };

          const updateScore = (delta) => {
            setScore(prev => {
              const newScore = Math.max(0, prev + delta);
              scoreRef.current = newScore;
              return newScore;
            });
          };

          const startGame = () => {
            if (progress.playsLeft <= 0) {
              const msg = "No plays left today! Come back tomorrow.";
              if (window.Telegram?.WebApp?.showAlert) window.Telegram.WebApp.showAlert(msg);
              else alert(msg);
              return;
            }
            initAudio();
            setScore(0);
            scoreRef.current = 0;
            setTimeLeft(30);
            timeLeftRef.current = 30;
            setItems([]);
            setIsFrozen(false);
            frozenRef.current = false;
            setPopEffects([]);
            setGameState(GameState.PLAYING);

            if (timerRef.current) clearInterval(timerRef.current);
            timerRef.current = setInterval(() => {
              if (frozenRef.current) return;
              setTimeLeft(prev => {
                const newVal = prev - 1;
                timeLeftRef.current = newVal;
                if (newVal <= 0) { endGame(); return 0; }
                return newVal;
              });
            }, 1000);
            startSpawner();
          };

          const endGame = () => {
            clearIntervals();
            setGameState(GameState.GAME_OVER);
            const finalScore = scoreRef.current;
            saveProgress(finalScore, 1);
            setProgress(prev => ({ ...prev, totalScore: prev.totalScore + finalScore, playsLeft: prev.playsLeft - 1 }));
            const user = window.Telegram?.WebApp?.initDataUnsafe?.user;
            const name = user?.username || user?.first_name || `Rodent-${Math.floor(Math.random()*1000)}`;
            submitScore(name, finalScore);
          };

          const startSpawner = () => {
            if (spawnRef.current) clearInterval(spawnRef.current);
            spawnRef.current = setInterval(() => {
              if (frozenRef.current) return;
              const t = timeLeftRef.current;
              const count = t > 15 ? (Math.random() > 0.5 ? 2 : 1) : (Math.random() > 0.3 ? 2 : 1);
              for(let i=0; i<count; i++) spawnItem();
            }, 550);
          };

          const spawnItem = () => {
            setItems(prev => {
              if (prev.length > 12) return prev;
              const r = Math.random();
              let type = ItemType.MELON;
              if (r > 0.78) type = ItemType.BOMB;
              if (r > 0.94) type = ItemType.ICE;
              return [...prev, {
                id: Math.random().toString(36).substr(2, 9),
                type,
                x: Math.floor(Math.random() * 80) + 10,
                duration: 2 + Math.random() * 2,
                delay: 0
              }];
            });
          };

          const handleHit = useCallback((id, type, x, y) => {
            setItems(prev => prev.filter(i => i.id !== id));
            if (type === ItemType.MELON) {
              playMelonSound(); updateScore(10); haptic('light'); addPopEffect(x, y, '+10', '#00ff88');
            } else if (type === ItemType.BOMB) {
              playBombSound(); updateScore(-5); haptic('heavy'); addPopEffect(x, y, '-5', '#ff4757');
              document.body.classList.add('animate-shake'); setTimeout(() => document.body.classList.remove('animate-shake'), 500);
            } else if (type === ItemType.ICE) {
              playIceSound(); haptic('medium'); addPopEffect(x, y, '‚ùÑÔ∏è FREEZE', '#74b9ff'); triggerFreeze();
            }
          }, []);

          const addPopEffect = (x, y, text, color) => {
            const id = Date.now().toString() + Math.random();
            setPopEffects(prev => [...prev, { id, x, y, text, color }]);
            setTimeout(() => setPopEffects(prev => prev.filter(p => p.id !== id)), 600);
          };

          const triggerFreeze = () => {
            setIsFrozen(true); frozenRef.current = true;
            if (freezeRef.current) clearTimeout(freezeRef.current);
            freezeRef.current = setTimeout(() => { setIsFrozen(false); frozenRef.current = false; }, 2000);
          };

          const handleMiss = useCallback((id) => setItems(prev => prev.filter(i => i.id !== id)), []);

          const handleDailyMine = () => {
            const today = new Date().toDateString();
            if (progress.lastMinedDate === today) {
              const msg = "Already mined today!";
              if (window.Telegram?.WebApp?.showAlert) window.Telegram.WebApp.showAlert(msg);
              else alert(msg);
              return;
            }
            const reward = Math.floor(Math.random() * 600) + 300;
            markMinedToday(reward);
            setProgress(prev => ({ ...prev, totalScore: prev.totalScore + reward, lastMinedDate: today }));
            playMelonSound();
            const msg = `Mined ${reward} Melons!`;
            if (window.Telegram?.WebApp?.showAlert) window.Telegram.WebApp.showAlert(msg);
            else alert(msg);
            haptic('medium');
          };

          const handleAirdrop = () => {
            const message = "Ready for a massive airdrop? It's launching soon";
            if (window.Telegram?.WebApp?.showAlert) window.Telegram.WebApp.showAlert(message);
            else alert(message);
          };

          return (
            <TonConnectUIProvider manifestUrl={MANIFEST_URL}>
              <div className="relative min-h-screen flex flex-col items-center font-sans text-white overflow-hidden">
                <div className="z-20 w-full p-4 flex justify-between items-center bg-gradient-to-b from-black/20 to-transparent">
                   <h1 className="text-2xl font-black drop-shadow-md">üçà Rodent Royal</h1>
                   <div className="bg-black/30 px-3 py-1 rounded-full text-sm font-mono backdrop-blur">
                     Total: {progress.totalScore.toLocaleString()}
                   </div>
                </div>

                <div className="relative w-full flex-grow max-w-2xl mx-auto">
                  {gameState === GameState.MENU && (
                      <div className="flex flex-col items-center justify-center h-full p-6 space-y-6 animate-fade-in">
                         <div className="text-6xl animate-bounce">üêπ</div>
                         <div className="bg-white/10 backdrop-blur-md p-6 rounded-3xl border border-white/20 text-center w-full">
                           <div className="text-lg mb-2 text-white/80">Plays Left Today</div>
                           <div className="text-4xl font-black text-yellow-300">{progress.playsLeft}/3</div>
                         </div>
                         <Button onClick={startGame} disabled={progress.playsLeft <= 0} className="text-xl py-4 flex items-center gap-2 justify-center w-64">
                           <Play fill="currentColor" /> PLAY GAME
                         </Button>
                         <div className="flex flex-col w-full gap-2">
                           <div className="flex gap-2 w-full justify-center">
                             <Button variant="secondary" onClick={handleDailyMine} className="flex-1 text-sm">
                               <Hammer size={16} className="mr-2 inline" /> Daily Mine
                             </Button>
                             <Button variant="accent" onClick={() => setGameState(GameState.REFERRAL)} className="flex-1 text-sm">
                               <Users size={16} className="mr-2 inline" /> Invite
                             </Button>
                           </div>
                           <div className="flex gap-2 w-full justify-center">
                             <Button variant="secondary" onClick={() => setGameState(GameState.SHOP)} className="flex-1 text-sm bg-yellow-400/20 hover:bg-yellow-400/30 border-yellow-300/30">
                               <ShoppingBag size={16} className="mr-2 inline text-yellow-300" /> Malon Shop
                             </Button>
                             <Button variant="secondary" onClick={handleAirdrop} className="flex-1 text-sm bg-indigo-500/20 hover:bg-indigo-500/30 border-indigo-400/30 text-indigo-100">
                               <Rocket size={16} className="mr-2 inline text-indigo-300" /> Airdrop
                             </Button>
                           </div>
                         </div>
                         <div className="rounded-2xl overflow-hidden shadow-lg transform scale-90"><TonConnectButton /></div>
                         <Leaderboard scores={leaderboard} loading={loadingLB} />
                      </div>
                  )}

                  {gameState === GameState.SHOP && <Shop onClose={() => setGameState(GameState.MENU)} />}
                  
                  {/* ADDED: Referral Modal */}
                  {gameState === GameState.REFERRAL && <ReferralModal onClose={() => setGameState(GameState.MENU)} />} 

                  {gameState === GameState.PLAYING && (
                    <div className="absolute inset-0 overflow-hidden rounded-xl border border-white/20 bg-white/5 backdrop-blur-sm m-2 shadow-2xl">
                      <div className="absolute top-4 left-0 right-0 flex justify-center z-20">
                        <div className={`px-6 py-2 rounded-full font-black text-4xl shadow-lg border-2 border-white/20 backdrop-blur-md transition-all duration-300 ${timeLeft <= 5 ? 'bg-red-500/80 animate-pulse scale-110' : 'bg-black/30'}`}>
                          {timeLeft}
                        </div>
                      </div>
                      <div className="absolute top-4 right-4 z-20 text-2xl font-bold drop-shadow-lg text-yellow-300">{score} üçà</div>
                      {items.map(item => <FallingObject key={item.id} data={item} isFrozen={isFrozen} onHit={handleHit} onMiss={handleMiss} />)}
                      {popEffects.map(pop => (
                        <div key={pop.id} className="absolute font-black text-4xl z-30 pointer-events-none animate-pop"
                          style={{ left: pop.x - 20, top: pop.y - 50, color: pop.color, textShadow: `0 0 10px ${pop.color}` }}>
                            {pop.text}
                        </div>
                      ))}
                    </div>
                  )}

                  {gameState === GameState.GAME_OVER && (
                      <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/70 backdrop-blur-sm z-40 p-6 animate-fade-in">
                          <h2 className="text-5xl font-black text-yellow-400 mb-4 drop-shadow-lg">GAME OVER!</h2>
                          <p className="text-xl text-white/80 mb-6">You earned:</p>
                          <div className="text-6xl font-black text-accent mb-8 drop-shadow-xl">{score} üçà</div>
                          <Button onClick={() => setGameState(GameState.MENU)} className="text-lg py-3 flex items-center gap-2 justify-center w-64">
                              <RotateCcw size={20} /> Back to Menu
                          </Button>
                      </div>
                  )}

                </div>
              </div>
            </TonConnectUIProvider>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>